<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../assets/css/indexCss.css">

  <title>Valid News</title>
</head>
<body id="indexPage">
<header>
  <ul id="headerButtons">
    <a href="../../index.html"><li>Valid News</li></a>
    <a><li>RELEVANCIA</li></a>
    <a><li>DA SEMANA</li></a>
    <a><li>ESPORTE</li></a>
  </ul>
  <span>
            <img src="../../assets/images/search_icon.png">
            <input type="text" name="" id="pesquisa">
        </span>
  <span id="loginSpan">
        </span>
</header>

<div id="loginMenu">
  <Button id="botaoFecharloginMenu">Fechar</Button>
  <Button id="botaoSair">Sair</Button>
</div>
<div id="noticias"></div>



</body>
<script defer>
  pesquisaInput = document.querySelector("#pesquisa")

  let userLogado = sessionStorage.getItem("usuarioCorrente")
  userLogado = JSON.parse(userLogado)
  console.log(userLogado)
  if (userLogado != null){
    document.querySelector("#loginSpan").innerHTML = `Bem vindo, ${userLogado.nome}`
    document.querySelector("#botaoSair").addEventListener("click", ()=>{
      sessionStorage.removeItem("usuarioCorrente")
      location.reload()
    })

    let bntLoginMenu = false
    document.querySelector("#loginSpan").addEventListener("click", ()=>{
      document.querySelector("#loginMenu").style.right = bntLoginMenu ? "-500px" : "0"
      bntLoginMenu = !bntLoginMenu
    })
    document.querySelector("#botaoFecharloginMenu").addEventListener("click", ()=>{
      document.querySelector("#loginMenu").style.right = "-500px"
      bntLoginMenu = false
    })
  } else {
    document.querySelector("#loginSpan").innerHTML = `<a href="./modulos/login/login.html"><h3>Login</h3></a>`
    document.querySelector("#loginMenu").style.display = "none"
  }

  async function ler() {
    const resposta = await fetch("http://localhost:3000/noticias");
    const dados = await resposta.json();
    return dados;
  }

  async function lerSemana() {
    const resposta = await fetch("http://localhost:3000/daSemana");
    const dados = await resposta.json();
    return dados;
  }

  function cardNoticia(id ,titulo, descricao, foto, data, mediaAvaliacoes){
    if (mediaAvaliacoes === 0 || mediaAvaliacoes == null){
      mediaAvaliacoes = 1
    }

    return `<a href="../../modulos/detalhes/News_Page.html?id=${id}"><div class="noticia">
            <img class="fotoNoticia" src="${foto}" alt="Imagem da notÃ­cia">
            <div class="noticia-conteudo">
                <span id="divNomeEstrelas"><h4>${titulo}</h4><img src="../../assets/images/stars${mediaAvaliacoes}.png" alt=""></span>
                <p>${descricao}</p>
                <p style="font-size: 0.8rem; color: gray;">${data}</p>
            </div>
        </div></a>`
  }

  function atualizarPagina(){
    let noticiasMain = document.querySelector("#noticias")
    noticiasMain.innerHTML = ""


    lerSemana().then((semanas)=>{
      ler().then(dados => {
        dados.forEach((dado)=>{

          if (semanas.includes(dado.id)){
            noticiasMain.innerHTML += cardNoticia(
                    dado.id,
                    dado.titulo,
                    dado.texto,
                    dado.thumb,
                    dado.data,
                    dado.mediaAvaliacoes,
                    dado.fonte
            )
          }
        })

        if (pesquisaInput.value != ""){
          dados = dados.filter(dado => dado.titulo.toLowerCase().includes(pesquisaInput.value))
        }
      });
    })



  }
  atualizarPagina()


</script>
</body>
</html>
